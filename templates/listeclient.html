<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD Interface</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Gestion des Données (CRUD)</h1>
        <table class="table">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Code</th>
                    <th>Phone</th>
                    <th>Id Carte</th>
                </tr>
            </thead>
            <tbody id="dataList"></tbody>
        </table>
        <button class="btn btn-success" id="addButton">Ajouter un utilisateur</button>
    </div>

    <!-- JavaScript intégré -->
    <script>
        const apiUrl = "http://127.0.0.1:5000"; // Remplacez par l'URL de votre serveur

        // Charger les données initiales
        async function loadData() {
            const response = await fetch(`${apiUrl}/get_data`);
            const data = await response.json();

            const dataList = document.getElementById("dataList");
            dataList.innerHTML = "";

            data.forEach((item) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${item.Nom}</td>
                    <td>${item.Code}</td>
                    <td>${item.Phone}</td>
                    <td>${item.Carte || "Non défini"}</td>
                `;
                row.style.cursor = "pointer";
                row.addEventListener("click", () => showEditDialog(item));
                dataList.appendChild(row);
            });
        }

        // Afficher un alert combobox pour modifier les données
        function showEditDialog(item) {
            const formHtml = `
                <div>
                    <label>Nom:</label><br>
                    <input type="text" id="editNom" value="${item.Nom}" class="form-control"><br>
                    <label>Code:</label><br>
                    <input type="text" id="editCode" value="${item.Code}" class="form-control"><br>
                    <label>Phone:</label><br>
                    <input type="text" id="editPhone" value="${item.Phone}" class="form-control"><br>
                    <label>Id Carte:</label><br>
                    <input type="text" id="editCarte" value="${item.Carte || ''}" class="form-control"><br>
                </div>
            `;

            if (confirmDialog(formHtml, "Modifier l'utilisateur", ["Annuler", "Supprimer", "Enregistrer"])) {
                const newNom = document.getElementById("editNom").value;
                const newCode = document.getElementById("editCode").value;
                const newPhone = document.getElementById("editPhone").value;
                const newCarte = document.getElementById("editCarte").value;

                updateData(item._id.$oid, { Nom: newNom, Code: newCode, Phone: newPhone, Carte: newCarte });
            }
        }

        // Afficher un alert combobox pour ajouter un utilisateur
        document.getElementById("addButton").addEventListener("click", () => {
            const formHtml = `
                <div>
                    <label>Nom:</label><br>
                    <input type="text" id="addNom" class="form-control"><br>
                    <label>Code:</label><br>
                    <input type="text" id="addCode" class="form-control"><br>
                    <label>Phone:</label><br>
                    <input type="text" id="addPhone" class="form-control"><br>
                    <label>Id Carte:</label><br>
                    <input type="text" id="addCarte" class="form-control"><br>
                </div>
            `;

            if (confirmDialog(formHtml, "Ajouter un utilisateur", ["Annuler", "Ajouter"])) {
                const nom = document.getElementById("addNom").value;
                const code = document.getElementById("addCode").value;
                const phone = document.getElementById("addPhone").value;
                const carte = document.getElementById("addCarte").value;

                createData({ Nom: nom, Code: code, Phone: phone, Carte: carte });
            }
        });

        // Confirmation dialog helper
        function confirmDialog(content, title, buttons) {
            const html = `
                <div class="modal fade" tabindex="-1" role="dialog" id="customDialog">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${title}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                ${content}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${buttons[0]}</button>
                                ${buttons[1] ? `<button type="button" class="btn btn-danger">${buttons[1]}</button>` : ''}
                                ${buttons[2] ? `<button type="button" class="btn btn-primary">${buttons[2]}</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML("beforeend", html);
        }

        async function createData(data) {
            const response = await fetch(`${apiUrl}/create`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                loadData();
            } else {
                alert("Erreur lors de l'ajout.");
            }
        }

        async function updateData(id, data) {
            const response = await fetch(`${apiUrl}/update/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                loadData();
            } else {
                alert("Erreur lors de la mise à jour.");
            }
        }

        loadData();
    </script>
</body>
</html>
